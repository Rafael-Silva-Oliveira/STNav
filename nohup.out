2024-06-15 21:28:53.944253: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library 'libcudart.so.11.0'; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory
2024-06-15 21:28:54.913394: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library 'libnvinfer.so.7'; dlerror: libnvinfer.so.7: cannot open shared object file: No such file or directory
2024-06-15 21:28:54.913566: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library 'libnvinfer_plugin.so.7'; dlerror: libnvinfer_plugin.so.7: cannot open shared object file: No such file or directory
2024-06-15 21:28:54.913579: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Cannot dlopen some TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please make sure the missing libraries mentioned above are installed properly.
WARNING:root:In order to use sagenet models, please install pytorch geometric (see https://pytorch-geometric.readthedocs.io) and 
 captum (see https://github.com/pytorch/captum).
WARNING:root:mvTCR is not installed. To use mvTCR models, please install it first using "pip install mvtcr"
WARNING:root:multigrate is not installed. To use multigrate models, please install it first using "pip install multigrate".
/mnt/work/RO_src/venv/stnav_venv/lib/python3.9/site-packages/stlearn/tools/microenv/cci/het.py:192: NumbaDeprecationWarning: The keyword argument 'nopython=False' was supplied. From Numba 0.59.0 the default is being changed to True and use of 'nopython=False' will raise a warning as the argument will have no effect. See https://numba.readthedocs.io/en/stable/reference/deprecation.html#deprecation-of-object-mode-fall-back-behaviour-when-using-jit for details.
  @jit(parallel=True, nopython=False)
2024-06-15 21:28:56.683 | INFO     | __main__:main:87 - Directory where outputs will be saved: /mnt/work/RO_src/data/processed/PipelineRun_2024_06_15-09_28_55_PM
2024-06-15 21:28:56.683 | ERROR    | STNav.orchestrator:initialize_adata_dict:101 - Error on usage: argument of type 'bool' is not iterable
2024-06-15 21:28:56.683 | ERROR    | STNav.orchestrator:initialize_adata_dict:101 - Error on usage: argument of type 'bool' is not iterable
2024-06-15 21:28:56.684 | ERROR    | STNav.orchestrator:initialize_adata_dict:101 - Error on load_images: argument of type 'bool' is not iterable
2024-06-15 21:28:56.684 | INFO     | STNav.orchestrator:run_pipeline_for_data_type:115 - Running Analysis for scRNA
2024-06-15 21:28:56.912 | INFO     | STNav.core:read_rna:71 - Loaded scRNA dataset with 1786 cells and 33567 genes.
2024-06-15 21:28:56.926 | WARNING  | STNav.core:read_rna:85 - Failed to set new index. This might've happened because the index of var is already the genes/feature names, so no changes need to be made.
2024-06-15 21:28:56.927 | INFO     | STNav.utils.helpers:save_processed_adata:214 - Saving scRNA data type with the name raw_adata.h5ad file.
2024-06-15 21:28:57.155 | INFO     | STNav.utils.helpers:save_processed_adata:270 - Saving data to adata_dict as 'raw_adata' for scRNA data type.
2024-06-15 21:28:57.317 | INFO     | STNav.core:QC:133 - Running quality control.
2024-06-15 21:28:57.414 | INFO     | STNav.core:QC:210 - Quantile is set to true. Lower and upper limits for n_genes_by_counts calculated: upper_lim_n_genes_by_counts = 2175.6 and lower_lim_n_genes_by_counts = 334.0
2024-06-15 21:28:57.481 | INFO     | STNav.utils.helpers:save_processed_adata:214 - Saving scRNA data type with the name QCed_adata.h5ad file.
2024-06-15 21:28:57.720 | INFO     | STNav.utils.helpers:save_processed_adata:270 - Saving data to adata_dict as 'QCed_adata' for scRNA data type.
2024-06-15 21:28:57.891 | INFO     | STNav.core:preprocessing:262 - Running preprocessing for scRNA with 'QCed_adata' adata file.
2024-06-15 21:28:57.892 | INFO     | STNav.core:preprocessing:269 - Current adata.X (raw data/counts) shape: 
 adata.X.shape = (1709, 33430)
2024-06-15 21:28:57.892 | INFO     | STNav.core:preprocessing:270 - Current adata.raw.X (raw data/counts) shape: 
 adata.raw.X.shape = (1709, 33567)
2024-06-15 21:28:57.893 | INFO     | STNav.core:preprocessing:274 - 
 The sum of UMIs from 3 first examples (cells scRNA or spots for ST) from adata.X before any filters or normalization: 
 1 - adata.X[0,:].sum() = 5014.0 
 2 - adata.X[1,:].sum() = 4840.0 
 3 - adata.X[2,:].sum() = 4685.0
2024-06-15 21:28:57.914 | INFO     | STNav.core:preprocessing:278 - adata.var contains the current gene information: 
 adata.var=                                                gene_ids  ... total_counts
Mir1302-2hg                              ENSG00000243485  ...          0.0
Fam138a                                  ENSG00000237613  ...          0.0
Or4f5                                    ENSG00000186092  ...          0.0
Al627309.1                               ENSG00000238009  ...          2.0
Al627309.3                               ENSG00000239945  ...          0.0
...                                                  ...  ...          ...
Sarscov2_sarscov2_orf8            SARSCoV2_SARSCoV2_ORF8  ...          0.0
Sarscov2_sarscov2_n                  SARSCoV2_SARSCoV2_N  ...          0.0
Sarscov2_sarscov2_orf10          SARSCoV2_SARSCoV2_ORF10  ...          0.0
Sarscov2_sarscov2_3prime        SARSCoV2_SARSCoV2_3prime  ...          0.0
Sarscov2_sarscov2_negstrand  SARSCoV2_SARSCoV2_NegStrand  ...          0.0

[33430 rows x 11 columns] 
 with the following columns: adata.var.columns=Index(['gene_ids', 'feature_types', 'genome', 'gene_names', 'Mt', 'Ribo', 'Hb',
       'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts',
       'total_counts'],
      dtype='object')
2024-06-15 21:28:57.937 | INFO     | STNav.core:preprocessing:281 - adata.obs contains the current cell/spot information: 
 adata.obs=                                     dataset  ... pct_counts_Hb
AGGTCATAGAGTACCG  test_dataset_delorey_regev  ...      0.000000
TAAGCGTTCGCTACGG  test_dataset_delorey_regev  ...      0.040816
GTCTTTAAGTCCCGAC  test_dataset_delorey_regev  ...      0.000000
TTTAGTCAGGGAGGTG  test_dataset_delorey_regev  ...      0.042499
GGGTAGATCGTGGAAG  test_dataset_delorey_regev  ...      0.021622
...                                      ...  ...           ...
ATTGGGTTCAAGTCGT  test_dataset_delorey_regev  ...      0.000000
GACCCAGTCGTAATGC  test_dataset_delorey_regev  ...      0.000000
CTCAGGGGTCCACTCT  test_dataset_delorey_regev  ...      0.000000
TGATGCACATGGGCAA  test_dataset_delorey_regev  ...      0.000000
ATGGGTTAGAGGCGTT  test_dataset_delorey_regev  ...      0.000000

[1709 rows x 24 columns] 
 with the following columns: adata.obs.columns=Index(['dataset', 'ann_level_1_transferred_label_unfiltered',
       'ann_level_2_transferred_label_unfiltered',
       'ann_level_3_transferred_label_unfiltered',
       'ann_level_4_transferred_label_unfiltered',
       'ann_level_5_transferred_label_unfiltered',
       'ann_level_1_transfer_uncert', 'ann_level_2_transfer_uncert',
       'ann_level_3_transfer_uncert', 'ann_level_4_transfer_uncert',
       'ann_level_5_transfer_uncert', 'ann_level_1_transferred_label',
       'ann_level_2_transferred_label', 'ann_level_3_transferred_label',
       'ann_level_4_transferred_label', 'ann_level_5_transferred_label',
       'n_genes_by_counts', 'total_counts', 'total_counts_Mt', 'pct_counts_Mt',
       'total_counts_Ribo', 'pct_counts_Ribo', 'total_counts_Hb',
       'pct_counts_Hb'],
      dtype='object')
2024-06-15 21:28:57.937 | INFO     | STNav.core:preprocessing:287 - Applying filtering genes with the following params {'data': 'adata', 'min_counts': 50, 'inplace': True} - Getting rid of genes that are found in fewer than 25 counts.
filtered out 24876 genes that are detected in less than 50 counts
2024-06-15 21:28:57.967 | INFO     | STNav.core:preprocessing:293 - 	After filtering genes: 1709 observations (cells if scRNA, spots if ST) x 8554 genes.
2024-06-15 21:28:57.970 | INFO     | STNav.core:preprocessing:324 - Applying normalization with the following params {'adata': 'adata', 'target_sum': 10000.0, 'inplace': True}
2024-06-15 21:28:57.970 | INFO     | STNav.core:preprocessing:328 - 
 The sum of UMIs from 3 first examples (cells scRNA or spots for ST) from adata.X before normalizing: 
 1 - adata.X[0,:].sum()= 4804.0 
 2 - adata.X[1,:].sum() = 4649.0 
 3 - adata.X[2,:].sum() = 4473.0
normalizing counts per cell
    finished (0:00:00)
2024-06-15 21:28:57.974 | INFO     | STNav.core:preprocessing:335 - 
 The sum of UMIs from 3 first examples (cells scRNA or spots for ST) from adata.X after normalizing: 
 1 - adata.X[0,:].sum() = 10000.017 
 2 - adata.X[1,:].sum() = 9999.949 
 3 - adata.X[2,:].sum() = 10000.035
2024-06-15 21:28:57.974 | INFO     | STNav.core:preprocessing:343 - Applying log1p with the following params {'base': None}
2024-06-15 21:28:57.976 | INFO     | STNav.core:preprocessing:350 - 
 Applying the log changed the counts from UMI counts to log counts. The sum of log counts from the 3 first examples (cells for scRNA or spots for ST) from adata.X after applying log: 
 1 - adata.X[0,:].sum() = 2763.6858 
 2 - adata.X[1,:].sum() = 2824.829 
 3 - adata.X[2,:].sum() = 2915.8845
2024-06-15 21:28:57.977 | INFO     | STNav.core:preprocessing:355 - Examples from saved 'lognorm' layer: [[0.   0.   0.   0.   0.   0.   1.13 0.   0.   0.   0.   0.   0.   0.
  0.   1.13 0.   0.   1.64 0.   0.   0.   0.   0.   0.   2.43 0.   0.
  0.   0.   0.   0.   0.   0.   0.   1.13 0.   0.   1.64 1.13 1.64 1.64
  0.   1.13 0.   1.98 0.   0.   0.   0.   0.   0.   0.   0.   0.   0.
  0.   0.   0.   0.   0.   0.   0.   0.   0.   0.   1.13 1.98 0.   0.  ]]
2024-06-15 21:28:57.977 | INFO     | STNav.core:preprocessing:361 - Selecting highly variable genes with the following params {'adata': 'adata', 'subset': True, 'n_top_genes': 10000, 'min_mean': 0.0125, 'max_mean': 2, 'min_disp': 0.25, 'flavor': 'seurat_v3', 'inplace': True}
If you pass `n_top_genes`, all cutoffs are ignored.
extracting highly variable genes
--> added
    'highly_variable', boolean vector (adata.var)
    'highly_variable_rank', float vector (adata.var)
    'means', float vector (adata.var)
    'variances', float vector (adata.var)
    'variances_norm', float vector (adata.var)
2024-06-15 21:28:58.132 | INFO     | STNav.core:preprocessing:379 - 
 After applying highly variable genes, 3 first examples (cells for scRNA or spots for ST) from adata.X after applying highly variable genes: 
 1 - adata.X[0,:].sum() = 2763.6858 
 2 - adata.X[1,:].sum() = 2824.829 
 3 - adata.X[2,:].sum() = 2915.8845
2024-06-15 21:28:58.132 | INFO     | STNav.core:preprocessing:400 - Adding extra info for plotting.
2024-06-15 21:28:58.132 | INFO     | STNav.core:preprocessing:403 - 	Applying pca with the following params {'data': 'adata', 'svd_solver': 'arpack'}
computing PCA
    on highly variable genes
    with n_comps=50
    finished (0:00:02)
2024-06-15 21:29:00.587 | INFO     | STNav.core:preprocessing:416 - 	Applying neighbors with the following params {'adata': 'adata', 'n_pcs': 30, 'n_neighbors': 20}
computing neighbors
    using 'X_pca' with n_pcs = 30
    finished: added to `.uns['neighbors']`
    `.obsp['distances']`, distances for each pair of neighbors
    `.obsp['connectivities']`, weighted adjacency matrix (0:00:06)
2024-06-15 21:29:07.313 | INFO     | STNav.core:preprocessing:425 - 	Applying umap with the following params {'adata': 'adata'}
computing UMAP
    finished: added
    'X_umap', UMAP coordinates (adata.obsm) (0:00:03)
2024-06-15 21:29:10.963 | INFO     | STNav.core:preprocessing:434 - 	Applying tsne with the following params {'adata': 'adata', 'n_pcs': 30}
computing tSNE
    using 'X_pca' with n_pcs = 30
    using sklearn.manifold.TSNE
    finished: added
    'X_tsne', tSNE coordinates (adata.obsm) (0:00:09)
2024-06-15 21:29:20.840 | INFO     | STNav.core:preprocessing:443 - Adding extra info for clustering
2024-06-15 21:29:20.841 | INFO     | STNav.core:preprocessing:446 - 	Applying leiden with the following params {'adata': 'adata', 'key_added': 'leiden_clusters', 'resolution': 0.75}
running Leiden clustering
    finished: found 10 clusters and added
    'leiden_clusters', the cluster labels (adata.obs, categorical) (0:00:00)
2024-06-15 21:29:21.324 | INFO     | STNav.core:preprocessing:466 - 	Applying hierarchical clustering with the following params {'n_clusters': 7, 'affinity': 'euclidean', 'linkage': 'ward'}
2024-06-15 21:29:21.392 | INFO     | STNav.core:preprocessing:483 - 	Applying dendogram with the following params {'groupby': 'ann_level_3_transferred_label'}
    using 'X_pca' with n_pcs = 50
Storing dendrogram info using `.uns['dendrogram_ann_level_3_transferred_label']`
2024-06-15 21:29:21.398 | INFO     | STNav.core:preprocessing:495 - Current adata.X shape after preprocessing: (1709, 8554)
2024-06-15 21:29:21.399 | INFO     | STNav.core:preprocessing:496 - Current adata.raw.X shape after preprocessing: 
 adata.raw.X.shape = (1709, 8554)
2024-06-15 21:29:21.399 | INFO     | STNav.core:preprocessing:500 - 
 After preprocessing with highly variable genes, the 3 first examples (cells for scRNA or spots for ST): 
 1 - adata.X[0,:].sum() = 2763.6858 
 2 - adata.X[1,:].sum() = 2824.829 
 3 - adata.X[2,:].sum() = 2915.8845
2024-06-15 21:29:21.400 | INFO     | STNav.core:preprocessing:502 - 
 After preprocessing on the preprocessed_counts layer, the 3 first examples (cells for scRNA or spots for ST): 
 1 - adata.raw.X[0,:].sum() = 2763.6858 
 2 - adata.raw.X[1,:].sum() = 2824.829 
 3 - adata.raw.X[2,:].sum() = 2915.8845
2024-06-15 21:29:21.400 | INFO     | STNav.core:preprocessing:506 - 
 After preprocessing on the raw_counts layer, the 3 first examples (cells for scRNA or spots for ST): 
 1 - adata.raw.X[0,:].sum() = 2763.6858 
 2 - adata.raw.X[1,:].sum() = 2824.829 
 3 - adata.raw.X[2,:].sum() = 2915.8845
2024-06-15 21:29:21.401 | INFO     | STNav.core:preprocessing:508 - 
 After preprocessing on the raw_counts layer, the 3 first examples (cells for scRNA or spots for ST): 
 1 - adata.layers[layer][0,:].sum() = 4804.0 
 2 - adata.layers[layer][1,:].sum() = 4649.0 
 3 - adata.layers[layer][2,:].sum() = 4473.0
2024-06-15 21:29:21.401 | INFO     | STNav.utils.helpers:save_processed_adata:214 - Saving scRNA data type with the name preprocessed_adata.h5ad file.
2024-06-15 21:29:21.648 | INFO     | STNav.utils.helpers:save_processed_adata:270 - Saving data to adata_dict as 'preprocessed_adata' for scRNA data type.
2024-06-15 21:29:21.814 | INFO     | STNav.core:DEG:522 - Running DEG for scRNA with 'preprocessed_adata' adata file.
2024-06-15 21:29:21.823 | INFO     | STNav.orchestrator:run_pipeline_for_data_type:115 - Running Analysis for ST
reading /mnt/work/RO_src/data/raw/VisiumHD/square_008um/filtered_feature_bc_matrix.h5
 (0:00:12)
/mnt/work/RO_src/venv/stnav_venv/lib/python3.9/site-packages/scanpy/readwrite.py:415: DtypeWarning: Columns (1,2,3,4,5) have mixed types. Specify dtype option on import or set low_memory=False.
  positions = pd.read_csv(files["tissue_positions_file"], header=None)
2024-06-15 21:29:43.924 | INFO     | STNav.core:read_visium:107 - Loaded 10X Visium dataset with 605471 sequencing spots and 18085 genes.
2024-06-15 21:29:43.934 | WARNING  | STNav.core:read_visium:119 - Failed to set new index _index. This might've happened because the index of var is already the genes/feature names, so no changes need to be made.
2024-06-15 21:29:43.934 | INFO     | STNav.utils.helpers:save_processed_adata:214 - Saving ST data type with the name raw_adata.h5ad file.
